
(function($){var lists=$(''),lastPosition=null,originalList=null,originalIndex=null,dragged=null,placeHolder=null,dropTargets=[];$.okDrag={opts:{},mouseDown:function(e,opts){D.opts=opts;if(D.opts.enableDrag&&!D.opts.enableDrag.call(e.target)){return false;}
lists=$(D.opts.listSelector);if(D.opts.allowNested){lists=lists.add(lists.find(D.opts.listType));}
dragged=$(e.target).closest(D.opts.itemSelector);var pOffset=dragged.offsetParent().offset(),offsetX=(e.pageX-dragged.offset().left)+pOffset.left,offsetY=(e.pageY-dragged.offset().top)+pOffset.top;if(e.button==2||dragged.is(D.opts.handleSelectorExclude)){return false;}
placeHolder=$(D.opts.placeHolderTemplate);dragged.trigger("dragStart").css({position:"absolute",opacity:0.8,"z-index":999,left:e.pageX-offsetX,top:e.pageY-offsetY}).after(placeHolder);D.cachedropTargets();D.cacheOriginalPosition();if(D.scroll){D.scroll.mousedown.call(dragged);}
$(document).bind('mouseup',D.dragStop).bind('mousemove',{x:offsetX,y:offsetY},D.dragStart);return false;},dragStart:function(e){var isect=D.intersection(e.pageX,e.pageY),list=dropTargets[isect[0]],item;dragged.css({top:e.pageY-e.data.y,left:e.pageX-e.data.x});if(D.scroll){D.scroll.mousemove.call(dragged,e,D.opts);}
if(isect&&(!D.opts.dragBetween?list.item[0]==originalList:true)){item=list.dropTargets[isect[1]];if(item&&item.item[0]!=placeHolder[0]){if(lastPosition!==null&&lastPosition.left>$(item.item[0]).offset().left+D.opts.tabSize){if(item.item.children(D.opts.listType).length===0){item.item.append(document.createElement(D.opts.listType));}
item.item.children(D.opts.listType).append(placeHolder);}else if(lastPosition===null||lastPosition.top>dragged.offset().top||lastPosition.left>dragged.offset().left){item.item.before(placeHolder);}else{item.item.after(placeHolder);}}else if(list&&list.dropTargets.length===0){list.item.append(placeHolder);}
D.cachedropTargets();lastPosition=dragged.offset();}
return false;},dragStop:function(e){placeHolder.before(dragged);dragged.css({position:"",top:"",left:"",opacity:"","z-index":""});placeHolder.remove();D.cleanup(originalList);dragged.trigger("dragStop",[originalIndex!=dragged.siblings().andSelf().index(dragged),originalList!=dragged.parent()[0]]);$(document).unbind('mouseup',D.dragStop).unbind('mousemove',D.dragStart);},cachedropTargets:function(){var list,item,listLoc,itemLoc;function buildLoc(el){var ret=el.offset();ret.right=ret.left+el.width();ret.bottom=ret.top+el.height();ret.item=el;return ret;}
dropTargets.length=0;lists.each(function(i){list=$(this);listLoc=buildLoc(list);listLoc.dropTargets=[];list.children(D.opts.itemSelector).not(dragged).each(function(i){listLoc.dropTargets.push(buildLoc($(this)));});dropTargets.push(listLoc);});},cacheOriginalPosition:function(){originalIndex=dragged.siblings().andSelf().index(dragged);originalList=dragged.parent()[0];},cleanup:function(list){if(list&&list.children.length===0){list.parentNode.removeChild(list);}
list=null;},intersection:function(mousex,mousey){var list,item,ret=[];function isIntersecting(el){return el.left<mousex&&el.right>mousex&&el.top<mousey&&el.bottom>mousey;}
for(var i=dropTargets.length-1;i>=0;i--){list=dropTargets[i];if(isIntersecting(list)){ret.push(i);for(var j=list.dropTargets.length-1;j>=0;j--){item=list.dropTargets[j];if(isIntersecting(item)){ret.push(j);return ret;}}
return ret;}}
return false;}};var D=$.okDrag;$.fn.okDrag=function(opts){opts=$.extend({itemSelector:"li",handleSelector:"li",handleSelectorExclude:"input",dragEnd:function(positionChanged,listChanged){},dragBetween:false,enableDrag:function(){return true;},placeHolderTemplate:"<li class='placeHolder'>&nbsp;</li>",allowNested:true,tabSize:20,listType:'ul',scrollSensitivity:20,scrollSpeed:20,scrollContainer:$(document)},opts);opts.listSelector=this.selector;$(this.selector).live('mousedown',function(e){if($(e.target).is(opts.handleSelector)){$.okDrag.mouseDown(e,opts);}
return false;});return this;};})(jQuery);
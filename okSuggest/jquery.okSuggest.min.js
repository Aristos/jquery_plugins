
(function($){var eventsBound;$.fn.okSuggest=function(opts){opts=$.extend({data:[],selected:null,minLength:1,keys:{select:[13],next:[40],prev:[38]},onInsert:function(textInput,str){return textInput.val(str);},notFound:function(textInput){},filter:function(string,searchTerm){return string.score(searchTerm);},helpText:"Begin typing to search"},opts);function selectResult(liveSearch,forward){var ul=liveSearch.contents().find("ul:first"),focused=ul.children("li.ui-selected"),toFocus=focused[forward?"next":"prev"]();if(toFocus.length===0||focused.length===0){toFocus=ul.children(forward?":first":":last");}
focused.removeClass("ui-selected");toFocus.addClass("ui-selected");return false;}
function insertResult(input,liveSearch){var selected=liveSearch.contents().find("li.ui-selected"),originalInput=input.prev();if(selected.length&&selected.html()!==""){if(originalInput.length&&originalInput[0].tagName=="SELECT"){originalInput[0].selectedIndex=selected.data('index');}
opts.onInsert.call(originalInput,input,selected.html().replace(/<strong>([^<]+)<\/strong>/ig,'$1'));liveSearch.contents().hide();}else{opts.notFound.call(originalInput.length?originalInput:input,input);}}
function keyupHandler(e){var input=$(e.target),liveSearch=input.parent().data("okSuggest"),val=$.trim(input.val());if(e.which==40){return selectResult(liveSearch,1);}else if(e.which==38){return selectResult(liveSearch,0);}else if(val.length>=opts.minLength){liveSearch.filter(val,opts.filter);if(!val||liveSearch.contents().find("li:first").length===0){return liveSearch.contents().hide();}else if(e.which!=13){return liveSearch.contents().show();}}else{return liveSearch.reset().contents().find("li:first").addClass("ui-selected");}}
function keydownHandler(e){var liveSearch=$(e.target).parent().data("okSuggest");toggleHelp(e);if(e.which==13){e.preventDefault();insertResult($(e.target),liveSearch);return false;}}
function clickHandler(e){var t=$(e.target),okSuggest=t.closest('div.okSuggest');$("li.ui-selected",okSuggest).removeClass("ui-selected");t.addClass('ui-selected');insertResult(okSuggest.find(".okSuggest-input"),okSuggest.data("okSuggest"));}
function toggleHelp(e){var vis=e.type=='focusin';$(e.target).nextAll(".okSuggest-help")[vis?'show':'hide']();}
if(!eventsBound){$("input.okSuggest-input").live({keydown:keydownHandler,keyup:keyupHandler,focus:toggleHelp,blur:toggleHelp});$(".okSuggest .liveSearch li").live('click',clickHandler);eventsBound=true;}
return this.each(function(){var self=$(this),val=self.val(),liveSearch,list,str;self.wrap("<div class='okSuggest'/>");if(this.tagName=="SELECT"){for(var i=0;i<this.children.length;i++){opts.data.push($.trim(this.children[i].innerHTML));}
val=$("option:selected",self).html();self=$("<input type='text' />").insertAfter(self.hide());}
if(opts.selected){val=opts.selected;}
liveSearch=$.liveSearch.create(opts.data,{className:"okSuggest-list"});list=liveSearch.contents().width(self.outerWidth(true));self.attr({autocomplete:'off',accesskey:self.attr("accesskey"),tabindex:self.attr("tabindex")}).addClass('okSuggest-input').val(val).after(list.hide()).after("<div class='okSuggest-help' style='display: none;'>"+opts.helpText+"</div></div>").parent().data('okSuggest',liveSearch);});};})(jQuery);